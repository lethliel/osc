version: "3.4"

x-obs: &obs
  image: registry.opensuse.org/opensuse/tools/images/containers151/osrt_miniobs:latest

x-testenv: &testenv
  image: registry.opensuse.org/opensuse/tools/images/containers_tumbleweed/osrt_testenv_tumbleweed:latest
  volumes:
    - "../..:/code"

services:
  db:
    <<: *obs
    command: /usr/lib/mysql/mysql-systemd-helper start
  cache:
    <<: *obs
    command: /usr/sbin/memcached -u memcached
  api:
    <<: *obs
    command: chroot --userspec=wwwrun / /bin/bash -c "cd /srv/www/obs/api && /usr/bin/bundle exec rails s -e production"
    depends_on:
      - db
      - cache
      - srcserver
      - repserver
      - servicedispatch
  srcserver:
    <<: *obs
    command: chroot --userspec=obsrun / /usr/lib/obs/server/bs_srcserver
  repserver:
    <<: *obs
    command: chroot --userspec=obsrun / /usr/lib/obs/server/bs_repserver
  servicedispatch:
    <<: *obs
    command: chroot --userspec=obsrun / /usr/lib/obs/server/bs_servicedispatch
  test:
    <<: *testenv
    depends_on:
      - api
    command: /code/dist/ci/docker-compose-test.sh
    cap_add:
      - SYS_PTRACE
